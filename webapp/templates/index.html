{% extends "base.html" %}
{% block title %}Traffic Dashboard{% endblock %}
{% block content %}
<section class="layout">
  <div class="card layout__primary" id="overview-card">
    <h2>Th√¥ng tin chung</h2>
    {% if analysis.overview %}
      <div class="stat-grid">
        <div class="stat-card">
          <span class="stat-label">T·ªïng s·ªë b·∫£n ghi</span>
          <span class="stat-value">{{ "{:,}".format((analysis.overview.total_rows or 0)|int) }}</span>
          <span class="stat-sub">Th∆∞ m·ª•c: <code>{{ output_dir }}</code></span>
        </div>
        <div class="stat-card alt">
          <span class="stat-label">T·ªëc ƒë·ªô trung b√¨nh</span>
          <span class="stat-value">{{ analysis.overview.avg_speed | default(0) | round(2) }} km/h</span>
          <span class="stat-sub">Giai ƒëo·∫°n: {{ analysis.overview.start_time }} ‚Üí {{ analysis.overview.end_time }}</span>
        </div>
        <div class="stat-card warning">
          <span class="stat-label">T·ªâ l·ªá c·∫£nh b√°o t·∫Øc ngh·∫Ωn</span>
          <span class="stat-value">{{ ((analysis.overview.congestion_ratio or 0) * 100) | round(1) }}%</span>
          <span class="stat-sub">X√°c su·∫•t trung b√¨nh: {{ analysis.overview.avg_prob_congestion | default(0) | round(2) }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Std t·ªëc ƒë·ªô theo gi·ªù (TB)</span>
          <span class="stat-value">
            {% if analysis.hourly_std_avg is not none %}
              {{ analysis.hourly_std_avg | round(2) }}
            {% else %}
              N/A
            {% endif %}
          </span>
          <span class="stat-sub">B·∫£n ghi ph√¢n c·ª•m: {{ analysis.cluster_total or "N/A" }}</span>
        </div>
      </div>
    {% else %}
      <p style="color: var(--muted);">Ch∆∞a c√≥ d·ªØ li·ªáu ph√¢n t√≠ch. H√£y ƒë·ªìng b·ªô k·∫øt qu·∫£ m·ªõi nh·∫•t.</p>
    {% endif %}
  </div>

  <div class="card layout__secondary" id="pipeline-card">
    <h2>T√¨nh tr·∫°ng pipeline</h2>
    {% if metrics %}
      {% set meta = metrics.metadata %}
      {% set durations = metrics.durations %}
      <div class="stat-grid">
        <div class="stat-card">
          <span class="stat-label">L·∫ßn ch·∫°y g·∫ßn nh·∫•t</span>
          <span class="stat-value" style="font-size:1rem;">{{ metrics.last_run_human or "Ch∆∞a c√≥ th√¥ng tin" }}</span>
          <span class="stat-sub">Pipeline th·ªß c√¥ng ho·∫∑c theo l·ªãch</span>
        </div>
        <div class="stat-card alt">
          <span class="stat-label">T·ªïng th·ªùi gian</span>
          <span class="stat-value">{{ (durations.get('total') or 0) | round(1) }}s</span>
          <span class="stat-sub">Optimize + Analytics: {{ ((durations.get('optimize_signals') or 0) + (durations.get('analytics') or 0)) | round(1) }}s</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">S·ªë c·ª•m t·ªëi ∆∞u</span>
          <span class="stat-value">k={{ meta.get('best_k', '?') }}</span>
          <span class="stat-sub">Silhouette cao nh·∫•t trong kho·∫£ng th·ª≠</span>
        </div>
      </div>
      <table class="table-compact">
        <thead>
          <tr>
            <th>B∆∞·ªõc</th>
            <th>Th·ªùi gian (s)</th>
          </tr>
        </thead>
        <tbody>
          {% for step, value in durations.items() if step != "total" %}
            <tr>
              <td>{{ step }}</td>
              <td>{{ value | round(2) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p style="color: var(--muted);">Ch∆∞a ghi nh·∫≠n metric. H√£y ch·∫°y pipeline ho·∫∑c ki·ªÉm tra file <code>metrics/pipeline_metrics.json</code>.</p>
    {% endif %}
  </div>
  </div>
</section>

<section class="layout layout--single">
  <div class="card">
  <h2>Xu h∆∞·ªõng theo th·ªùi gian</h2>
  <div class="chart-grid">
    <div class="chart-container">
      <canvas id="chartHourly"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="chartWeekday"></canvas>
    </div>
  </div>
  </div>
</section>

<section class="layout layout--single" id="analysis-speed-trends">
  <div class="card">
  <h2>Ph√¢n b·ªë & Xu h∆∞·ªõng t·ªëc ƒë·ªô</h2>
  <div class="chart-grid">
    <div class="chart-container">
      <canvas id="chartHistogram"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="chartDaily"></canvas>
    </div>
  </div>
  </div>
</section>

<section class="layout layout--single" id="analysis-heatmap">
  <div class="card">
    <h2>Heatmap t·ªëc ƒë·ªô (Gi·ªù √ó Ng√†y trong tu·∫ßn)</h2>
    <div id="heatmap-table" class="heatmap-wrapper"></div>
  </div>
</section>

<section class="layout layout--single" id="analysis-sensor">
  <div class="card">
  <h2>Ho·∫°t ƒë·ªông & So s√°nh c·∫£m bi·∫øn</h2>
  <div class="chart-grid">
    <div class="chart-container chart-container--tall">
      <canvas id="chartSensorActivity"></canvas>
    </div>
    <div class="chart-container chart-container--tall">
      <canvas id="chartTopSensor"></canvas>
    </div>
  </div>
  </div>
</section>

<section class="layout layout--single" id="realtime-card">
  <div class="card card-highlight">
    <div class="card-header-icon">
      <div class="card-header-text">
        <h2>D·ª± b√°o th·ªùi gian th·ª±c</h2>
        <p>Nh·∫≠p s·ªë li·ªáu c·∫£m bi·∫øn hi·ªán t·∫°i ƒë·ªÉ ∆∞·ªõc l∆∞·ª£ng x√°c su·∫•t t·∫Øc ngh·∫Ωn trong 15 ph√∫t t·ªõi.</p>
      </div>
      <span class="card-icon">‚ö°</span>
    </div>
    <form id="realtime-form" class="form-grid" autocomplete="off">
      <div class="form-group">
        <label for="realtime-road">Ch·ªçn tuy·∫øn ƒë∆∞·ªùng</label>
        <select id="realtime-road" name="road_id">
          <option value="">Ch·ªçn nhanh tuy·∫øn ƒë∆∞·ªùng</option>
          <option value="nguyen-thi-tu">280 Nguy·ªÖn Th·ªã T√∫ ‚Üí ƒêH C√¥ng Th∆∞∆°ng</option>
          <option value="an-suong-thu-duc">BX An S∆∞∆°ng ‚Üí Ch·ª£ ƒë·∫ßu m·ªëi Th·ªß ƒê·ª©c</option>
        </select>
      </div>
      <div class="form-group span-2">
        <label for="realtime-location">V·ªã tr√≠ / Ghi ch√∫</label>
        <input type="text" id="realtime-location" name="location" placeholder="V√≤ng xoay H√†ng Xanh">
      </div>
      <div class="form-group">
        <label for="realtime-avg-speed">T·ªëc ƒë·ªô trung b√¨nh (km/h) *</label>
        <input type="number" step="0.1" min="0" id="realtime-avg-speed" name="avg_speed" required>
      </div>
      <input type="hidden" id="realtime-std-speed" name="std_speed_hour" value="auto">
      <div class="form-group">
        <label for="realtime-hour">Gi·ªù (0-23)</label>
        <input type="number" min="0" max="23" id="realtime-hour" name="hour" placeholder="T·ª± ƒë·ªông n·∫øu b·ªè tr·ªëng">
      </div>
      <div class="form-group">
        <label for="realtime-weekday">Th·ª© (1=CN)</label>
        <select id="realtime-weekday" name="weekday">
          <option value="">T·ª± ƒë·ªông</option>
          <option value="1">Ch·ªß nh·∫≠t</option>
          <option value="2">Th·ª© hai</option>
          <option value="3">Th·ª© ba</option>
          <option value="4">Th·ª© t∆∞</option>
          <option value="5">Th·ª© nƒÉm</option>
          <option value="6">Th·ª© s√°u</option>
          <option value="7">Th·ª© b·∫£y</option>
        </select>
      </div>
      <div class="form-group">
        <label for="realtime-timestamp">Th·ªùi ƒëi·ªÉm quan s√°t</label>
        <input type="datetime-local" id="realtime-timestamp" name="timestamp">
      </div>
      <div class="form-group">
        <label for="realtime-lat">Vƒ© ƒë·ªô (t√πy ch·ªçn)</label>
        <input type="number" step="0.000001" id="realtime-lat" name="latitude" placeholder="10.801900">
      </div>
      <div class="form-group">
        <label for="realtime-lon">Kinh ƒë·ªô (t√πy ch·ªçn)</label>
        <input type="number" step="0.000001" id="realtime-lon" name="longitude" placeholder="106.712300">
      </div>
      <div class="form-group span-2 form-actions">
        <button type="submit" id="realtime-submit" class="btn-primary">D·ª± b√°o ngay</button>
        <button type="button" id="realtime-refresh" class="btn-icon" title="C·∫≠p nh·∫≠t th·ªùi gian quan s√°t">
          üîÑ
        </button>
      </div>
    </form>
    <div id="realtime-result" class="realtime-result">
      <p style="color: var(--muted); margin: 0;">Nh·∫≠p th√¥ng tin v√† nh·∫•n ‚ÄúD·ª± b√°o ngay‚Äù ƒë·ªÉ xem k·∫øt qu·∫£ th·ªùi gian th·ª±c.</p>
    </div>
    <p style="color: var(--muted); font-size: 0.85rem; margin-top: 12px;">
      üìå H√£y ƒë·∫£m b·∫£o Spark c√≥ th·ªÉ kh·ªüi ch·∫°y local. ƒê·∫∑t bi·∫øn <code>SPARK_LOCAL_IP</code>, <code>SPARK_DRIVER_HOST</code>, <code>SPARK_MASTER</code> tr∆∞·ªõc khi ch·∫°y <code>python3 webapp/app.py</code>.
    </p>
  </div>
</section>

<section class="layout layout--single" id="signal-plan">
  <div class="card">
    <div class="card-header-icon">
      <div class="card-header-text">
        <h2>T·ªëi ∆∞u chu k·ª≥ ƒë√®n</h2>
        <p>D·ª±a tr√™n x√°c su·∫•t t·∫Øc ngh·∫Ωn trung b√¨nh theo gi·ªù, h·ªá th·ªëng ƒë·ªÅ xu·∫•t ƒëi·ªÅu ch·ªânh pha xanh cho c√°c n√∫t giao ch√≠nh.</p>
      </div>
      <span class="card-icon">üö¶</span>
    </div>
    {% set signal_records = signal_plan.records or [] %}
    {% if signal_records %}
      <div class="stat-grid">
        {% set top = signal_plan.top or [] %}
        {% if top %}
          {% set best = top[0] %}
          <div class="stat-card warning">
            <span class="stat-label">R·ªßi ro cao nh·∫•t</span>
            <strong>{{ best.date }} ¬∑ {{ "%02d"|format(best.hour or 0) }}h</strong>
            <small style="color: var(--muted); font-size: 0.82rem;">
              X√°c su·∫•t {{ best.avg_prob_percent | default(0) }}% ¬∑ {{ best.strategy or '‚Äî' }}
            </small>
          </div>
        {% endif %}
        <div class="stat-card">
          <span class="stat-label">S·ªë khuy·∫øn ngh·ªã</span>
          <strong>{{ signal_records|length }}</strong>
          <small style="color: var(--muted); font-size: 0.82rem;">
            {% if signal_plan.last_updated_human %}
              C·∫≠p nh·∫≠t l√∫c {{ signal_plan.last_updated_human }}
            {% else %}
              ƒê∆∞·ª£c t·∫°o t·ª´ l√¥ d·ª± b√°o m·ªõi nh·∫•t
            {% endif %}
          </small>
        </div>
        {% if top and top|length > 1 %}
          <div class="stat-card">
            <span class="stat-label">Top 3 ƒë·ªÅ xu·∫•t</span>
            <small style="color: var(--muted); font-size: 0.82rem;">
              {% for item in top[:3] %}
                {{ item.date }} {{ "%02d"|format(item.hour or 0) }}h ({{ item.avg_prob_percent|default(0) }}%)<br>
              {% endfor %}
            </small>
          </div>
        {% endif %}
      </div>
      <div class="table-scroll" style="margin-top: 18px;">
        <table>
          <thead>
            <tr>
              <th>Ng√†y</th>
              <th>Gi·ªù</th>
              <th>X√°c su·∫•t</th>
              <th>T·ªëc ƒë·ªô TB</th>
              <th>M·∫´u</th>
              <th>ƒêi·ªÅu ch·ªânh</th>
              <th>Chi·∫øn l∆∞·ª£c</th>
            </tr>
          </thead>
          <tbody>
            {% for row in signal_records[:30] %}
              <tr>
                <td>{{ row.date }}</td>
                <td>{{ "%02d"|format(row.hour or 0) }}h</td>
                <td>{{ row.avg_prob_percent | default(0) }}%</td>
                <td>
                  {% if row.avg_speed is not none %}
                    {{ row.avg_speed }} km/h
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>
                <td>{{ row.count_samples | default(0) }}</td>
                <td>
                  {% if row.green_extension_pct is not none %}
                    {{ row.green_extension_pct }}%
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>
                <td>{{ row.strategy or '‚Äî' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <p style="color: var(--muted); font-size: 0.82rem; margin-top: 12px;">
        * Gi√° tr·ªã d∆∞∆°ng nghƒ©a l√† k√©o d√†i pha xanh cho h∆∞·ªõng ƒëang ƒë√¥ng; gi√° tr·ªã √¢m nghƒ©a l√† r√∫t ng·∫Øn ƒë·ªÉ ∆∞u ti√™n h∆∞·ªõng kh√°c.
      </p>
    {% else %}
      <p style="color: var(--muted); margin: 0;">Ch∆∞a c√≥ d·ªØ li·ªáu t·ªëi ∆∞u chu k·ª≥ ƒë√®n. H√£y ch·∫°y pipeline ƒë·ªÉ t·∫°o khuy·∫øn ngh·ªã m·ªõi.</p>
    {% endif %}
  </div>
</section>

<section class="layout cluster-layout">
  <div class="card" id="analysis-cluster">
    <h2>Ph√¢n b·ªë c·ª•m KMeans</h2>
    {% if analysis.cluster %}
      <div class="cluster-grid">
        {% for row in analysis.cluster %}
          {% set percent = (row.row_count / (analysis.cluster_total or 1) * 100) if analysis.cluster_total else 0 %}
          <div class="cluster-card">
            <div class="cluster-card__header">
              <span class="cluster-card__label">C·ª•m {{ row.prediction }}</span>
              <span class="cluster-card__badge">{{ percent | round(1) }}%</span>
            </div>
            <div class="cluster-card__body">
              {% set raw_label = row.cluster_label %}
              {% if raw_label is none or raw_label|string|trim == '' or raw_label == 'N/A' %}
                {% set display_label = 'C·ª•m ' ~ row.prediction %}
              {% else %}
                {% set display_label = raw_label %}
              {% endif %}
              <span class="cluster-card__title">{{ display_label }}</span>
              <div class="cluster-card__stats">
                <div><span>T·ªëc ƒë·ªô TB</span><strong>{{ row.avg_speed_mean | round(2) }} km/h</strong></div>
                <div><span>S·ªë b·∫£n ghi</span><strong>{{ "{:,}".format(row.row_count) }}</strong></div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>Ch∆∞a c√≥ th·ªëng k√™ c·ª•m.</p>
    {% endif %}
  </div>

  <div class="card" id="analysis-top-hour">
    <h2>Top khung gi·ªù c√≥ nguy c∆° t·∫Øc ngh·∫Ωn</h2>
    {% if analysis.top %}
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>Ng√†y</th>
              <th>Gi·ªù</th>
              <th>X√°c su·∫•t TB</th>
              <th>S·ªë m·∫´u</th>
            </tr>
          </thead>
          <tbody>
            {% for row in analysis.top[:10] %}
              <tr>
                <td>{{ row.date }}</td>
                <td>{{ row.hour }}</td>
                <td>{{ row.avg_prob | round(3) }}</td>
                <td>{{ "{:,}".format(row.count|int) }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if analysis.top|length > 10 %}
        <p style="color:var(--muted); font-size:0.85rem; margin-top:8px;">(Hi·ªÉn th·ªã 10 d√≤ng c√≥ x√°c su·∫•t cao nh·∫•t)</p>
      {% endif %}
    {% else %}
      <p>Ch∆∞a c√≥ d·ªØ li·ªáu v·ªÅ khung gi·ªù t·∫Øc ngh·∫Ωn.</p>
    {% endif %}
  </div>
</section>

<section class="layout layout--single" id="logistic-section">
  <div class="card card-highlight">
    <div class="card-header-icon">
      <div class="card-header-text">
        <h2>K·∫øt qu·∫£ d·ª± b√°o t·∫Øc ngh·∫Ωn</h2>
        <p>Ch·ªçn m·ªôt l·∫ßn ch·∫°y Logistic Regression ƒë·ªÉ xem b·∫£ng x√°c su·∫•t v√† ph√¢n t√≠ch chi ti·∫øt.</p>
      </div>
      <span class="card-icon">üìà</span>
    </div>
    {% if runs %}
      <div class="prediction-grid">
        {% for run in runs %}
          {% set parts = run.split('_') %}
          {% set suffix = parts[-1] %}
          {% if suffix.endswith('m') %}
            {% set horizon_label = suffix[:-1] ~ " ph√∫t" %}
          {% elif suffix.endswith('h') %}
            {% set horizon_label = suffix[:-1] ~ " gi·ªù" %}
          {% else %}
            {% set horizon_label = suffix.replace('-', ' ') %}
          {% endif %}
          {% set display_title = "D·ª± b√°o " ~ horizon_label ~ " t·ªõi" %}
          {% set source_hint = ("Th∆∞ m·ª•c: " ~ run) %}
          <a class="prediction-card" href="{{ url_for('prediction_detail', run_name=run) }}">
            <div>
              <span class="prediction-pill">Logistic ¬∑ {{ horizon_label }}</span>
              <h3>{{ display_title }}</h3>
              <p>{{ source_hint }}</p>
            </div>
            <span class="prediction-arrow">‚Üí</span>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <p>Ch∆∞a th·∫•y th∆∞ m·ª•c <code>predict_*</code> n√†o. H√£y ch·∫°y pipeline tr∆∞·ªõc.</p>
    {% endif %}
  </div>
</section>

{% if analysis.feature_importance %}
<section class="layout layout--single">
  <div class="card">
    <h2>ƒê·ªô quan tr·ªçng ƒë·∫∑c tr∆∞ng</h2>
    <p style="color: var(--muted); margin-bottom: 16px;">Bi·ªÉu ƒë·ªì m√¥ t·∫£ m·ª©c ƒë√≥ng g√≥p t∆∞∆°ng ƒë·ªëi c·ªßa t·ª´ng ƒë·∫∑c tr∆∞ng trong m√¥ h√¨nh logistic hi·ªán t·∫°i.</p>
    <div class="chart-grid">
      <div class="chart-container">
        <canvas id="chartFeatureImportance"></canvas>
      </div>
    </div>
  </div>
</section>
{% endif %}

<div class="card">
  <h2>Bi·ªÉu ƒë·ªì KMeans</h2>
  {% if plots %}
    <div style="display:flex; flex-wrap:wrap; gap:16px;">
      {% for plot in plots %}
        <div style="flex:1 1 320px;">
          <a href="{{ url_for('serve_plot', filename=plot) }}" target="_blank">
            <img src="{{ url_for('serve_plot', filename=plot) }}" alt="{{ plot }}" style="width:100%; border-radius:12px; box-shadow:0 12px 24px rgba(56,189,248,0.25);" />
          </a>
          <p style="text-align:center; margin-top:8px;">{{ plot }}</p>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>Ch∆∞a c√≥ ·∫£nh trong <code>plots_kmeans</code>.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
  const roads = [
    {
      id: 'nguyen-thi-tu',
      name: '280 Nguy·ªÖn Th·ªã T√∫ ‚Üí ƒê·∫°i h·ªçc C√¥ng Th∆∞∆°ng',
      start: { lat: 10.8156988344, lon: 106.5865112907 },
      end: { lat: 10.8066598944, lon: 106.6287395048 },
      defaultSpeed: 30.0
    },
    {
      id: 'an-suong-thu-duc',
      name: 'B·∫øn xe An S∆∞∆°ng ‚Üí Ch·ª£ ƒë·∫ßu m·ªëi Th·ªß ƒê·ª©c',
      start: { lat: 10.8455708823, lon: 106.6133657368 },
      end: { lat: 10.8706316497, lon: 106.7289095028 },
      defaultSpeed: 40.0
    }
  ];

  const realtimeForm = document.getElementById('realtime-form');
  const realtimeResult = document.getElementById('realtime-result');
  const realtimeSubmit = document.getElementById('realtime-submit');
  const realtimeRefresh = document.getElementById('realtime-refresh');
  const roadSelect = document.getElementById('realtime-road');
  const locationInput = document.getElementById('realtime-location');
  const avgSpeedInput = document.getElementById('realtime-avg-speed');
  const hourInput = document.getElementById('realtime-hour');
  const weekdaySelect = document.getElementById('realtime-weekday');
  const timestampInput = document.getElementById('realtime-timestamp');
  const latInput = document.getElementById('realtime-lat');
  const lonInput = document.getElementById('realtime-lon');
  let locationAutoFilled = true;
  let selectedRoad = null;

  const pad = (num) => String(num).padStart(2, '0');

  const setObservationTime = (force = false) => {
    const now = new Date();
    if (hourInput && (force || hourInput.value === '')) {
      hourInput.value = String(now.getHours());
    }
    if (weekdaySelect && (force || !weekdaySelect.value)) {
      const jsDay = now.getDay();
      const sparkDay = jsDay === 0 ? 1 : jsDay + 1;
      weekdaySelect.value = String(sparkDay);
    }
    if (timestampInput && (force || timestampInput.value === '')) {
      timestampInput.value = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
    }
  };

  const applyRoadSelection = (roadId) => {
    if (!roadId) {
      selectedRoad = null;
      return;
    }
    const road = roads.find(r => r.id === roadId);
    if (!road) {
      selectedRoad = null;
      return;
    }
    selectedRoad = road;

    if (avgSpeedInput && !avgSpeedInput.value && road.defaultSpeed) {
      avgSpeedInput.value = road.defaultSpeed;
    }

    if (locationInput && (locationAutoFilled || !locationInput.value)) {
      locationInput.value = road.name;
      locationAutoFilled = true;
    }

    if (latInput && (latInput.dataset.manual !== 'true' || latInput.value === '')) {
      latInput.value = road.start.lat.toFixed(6);
      latInput.dataset.manual = 'false';
    }
    if (lonInput && (lonInput.dataset.manual !== 'true' || lonInput.value === '')) {
      lonInput.value = road.start.lon.toFixed(6);
      lonInput.dataset.manual = 'false';
    }
  };

  if (locationInput) {
    locationInput.addEventListener('input', () => {
      locationAutoFilled = locationInput.value.trim() === '';
    });
  }

  if (latInput) {
    latInput.addEventListener('input', () => {
      latInput.dataset.manual = latInput.value.trim() !== '' ? 'true' : 'false';
    });
  }

  if (lonInput) {
    lonInput.addEventListener('input', () => {
      lonInput.dataset.manual = lonInput.value.trim() !== '' ? 'true' : 'false';
    });
  }

  if (roadSelect) {
    roadSelect.addEventListener('change', (event) => {
      applyRoadSelection(event.target.value);
    });
  }

  const isFiniteNumber = (value) => typeof value === 'number' && Number.isFinite(value);
  const parseNullableNumber = (value) => {
    if (typeof value === 'number') {
      return Number.isFinite(value) ? value : null;
    }
    if (typeof value === 'string' && value.trim() !== '') {
      const parsed = Number(value);
      return Number.isFinite(parsed) ? parsed : null;
    }
    if (value && typeof value.valueOf === 'function') {
      const parsed = Number(value.valueOf());
      return Number.isFinite(parsed) ? parsed : null;
    }
    return null;
  };
  const toPercent = (value) => isFiniteNumber(value) ? `${(value * 100).toFixed(1)}%` : 'N/A';

  const showRealtimeLoading = () => {
    if (!realtimeResult) return;
    realtimeResult.innerHTML = '';
    const p = document.createElement('p');
    p.style.color = 'var(--muted)';
    p.style.margin = '0';
    p.textContent = 'ƒêang t√≠nh to√°n d·ª± b√°o...';
    realtimeResult.appendChild(p);
  };

  const showRealtimeError = (message, details) => {
    if (!realtimeResult) return;
    realtimeResult.innerHTML = '';
    const p = document.createElement('p');
    p.className = 'realtime-error';
    p.textContent = message || 'Kh√¥ng th·ªÉ d·ª± b√°o.';
    realtimeResult.appendChild(p);
    if (Array.isArray(details) && details.length) {
      const ul = document.createElement('ul');
      ul.className = 'realtime-error';
      ul.style.margin = '0 0 0 18px';
      details.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        ul.appendChild(li);
      });
      realtimeResult.appendChild(ul);
    } else if (details && typeof details === 'string') {
      const detailP = document.createElement('p');
      detailP.className = 'realtime-error';
      detailP.style.fontSize = '0.85rem';
      detailP.textContent = details;
      realtimeResult.appendChild(detailP);
    }
  };

  const createStatCard = (label, value, extra, variant) => {
    const card = document.createElement('div');
    card.className = 'stat-card';
    if (variant) card.classList.add(variant);
    const labelSpan = document.createElement('span');
    labelSpan.className = 'stat-label';
    labelSpan.textContent = label;
    card.appendChild(labelSpan);
    const valueStrong = document.createElement('strong');
    valueStrong.textContent = value;
    card.appendChild(valueStrong);
    if (extra) {
      const extraSmall = document.createElement('small');
      extraSmall.style = 'color: var(--muted); font-size: 0.8rem;';
      extraSmall.textContent = extra;
      card.appendChild(extraSmall);
    }
    return card;
  };

  const showRealtimeSuccess = (data) => {
    if (!realtimeResult) return;
    realtimeResult.innerHTML = '';

    const probValue = parseNullableNumber(data?.prob_congestion);
    const probPercent = probValue !== null ? toPercent(probValue) : 'N/A';

    const statusDiv = document.createElement('div');
    statusDiv.className = 'realtime-result__status';
    statusDiv.classList.add(data?.prediction === 1 ? 'realtime-result__status--risk' : 'realtime-result__status--ok');

    const title = document.createElement('h3');
    const locationLabel = data?.inputs?.location ? ` ¬∑ ${data.inputs.location}` : '';
    title.textContent = `${data?.prediction === 1 ? '‚ö†Ô∏è Nguy c∆° t·∫Øc ngh·∫Ωn' : '‚úÖ Giao th√¥ng th√¥ng tho√°ng'}${locationLabel}`;
    statusDiv.appendChild(title);

    const probSpan = document.createElement('span');
    probSpan.textContent = probPercent;
    statusDiv.appendChild(probSpan);
    realtimeResult.appendChild(statusDiv);

    const statGrid = document.createElement('div');
    statGrid.className = 'stat-grid';

    const variant = data?.prediction === 1 ? 'warning' : 'alt';
    statGrid.appendChild(createStatCard('X√°c su·∫•t 15 ph√∫t t·ªõi', probPercent, null, variant));

    const strategy = data?.strategy || {};
    const adjustValue = parseNullableNumber(strategy.green_extension_pct);
    const adjustText = adjustValue !== null
      ? `ƒêi·ªÅu ch·ªânh: ${adjustValue > 0 ? '+' : ''}${adjustValue}%`
      : 'ƒêi·ªÅu ch·ªânh: ‚Äî';
    statGrid.appendChild(createStatCard(
      'Khuy·∫øn ngh·ªã ƒë√®n',
      strategy.strategy || 'Kh√¥ng c√≥ d·ªØ li·ªáu',
      adjustText
    ));

    const speedValue = parseNullableNumber(data?.inputs?.avg_speed);
    const speedText = speedValue !== null ? `${speedValue.toFixed(1)} km/h` : '‚Äî';
    const contextText = `Gi·ªù ${data?.inputs?.hour ?? '‚Äî'} ¬∑ Th·ª© ${data?.inputs?.weekday ?? '‚Äî'}`;
    statGrid.appendChild(createStatCard('Th√¥ng tin quan s√°t', speedText, contextText));

    const distribution = Array.isArray(data?.probability_distribution) ? data.probability_distribution : null;
    if (distribution && distribution.length >= 2) {
      const p0 = parseNullableNumber(distribution[0]);
      const p1 = parseNullableNumber(distribution[1]);
      const parts = [];
      if (p0 !== null) parts.push(`Tho√°ng: ${toPercent(p0)}`);
      if (p1 !== null) parts.push(`T·∫Øc ngh·∫Ωn: ${toPercent(p1)}`);
      if (parts.length) {
        statGrid.appendChild(createStatCard('Ph√¢n b·ªë x√°c su·∫•t', parts.join(' ¬∑ ')));
      }
    }

    realtimeResult.appendChild(statGrid);

    const footer = document.createElement('p');
    footer.style.color = 'var(--muted)';
    footer.style.fontSize = '0.8rem';
    footer.style.margin = '0';
    const observed = data?.inputs?.timestamp ? new Date(data.inputs.timestamp) : null;
    const observedLabel = observed && !Number.isNaN(observed.getTime())
      ? observed.toLocaleString('vi-VN', { hour12: false })
      : 'N/A';
    const modelLabel = data?.model?.path ? ` ¬∑ Model: ${data.model.path}` : '';
    footer.textContent = `Quan s√°t l√∫c ${observedLabel}${modelLabel}`;
    realtimeResult.appendChild(footer);
  };

  const collectRealtimePayload = () => {
    const payload = {};
    if (!realtimeForm) {
      return payload;
    }
    const formData = new FormData(realtimeForm);

    const roadId = formData.get('road_id');
    if (roadId) {
      payload.road_id = roadId;
    }

    const avgSpeedRaw = formData.get('avg_speed');
    if (avgSpeedRaw !== null && avgSpeedRaw !== '') {
      const avgSpeed = Number(avgSpeedRaw);
      if (!Number.isNaN(avgSpeed)) {
        payload.avg_speed = avgSpeed;
      }
    }

    const stdSpeedRaw = formData.get('std_speed_hour');
    if (stdSpeedRaw === null || String(stdSpeedRaw).trim() === '') {
      payload.std_speed_hour = 'auto';
    } else {
      payload.std_speed_hour = String(stdSpeedRaw).trim();
    }

    const hourRaw = formData.get('hour');
    if (hourRaw !== null && hourRaw !== '') {
      const hourValue = Number(hourRaw);
      if (!Number.isNaN(hourValue)) {
        payload.hour = hourValue;
      }
    }

    const weekdayRaw = formData.get('weekday');
    if (weekdayRaw !== null && weekdayRaw !== '') {
      const weekdayValue = Number(weekdayRaw);
      if (!Number.isNaN(weekdayValue)) {
        payload.weekday = weekdayValue;
      }
    }

    const timestampRaw = formData.get('timestamp');
    if (timestampRaw !== null && timestampRaw !== '') {
      payload.timestamp = timestampRaw;
    }

    const location = formData.get('location');
    if (location !== null && location.trim() !== '') {
      payload.location = location.trim();
    }

    const latRaw = formData.get('latitude');
    if (latRaw !== null && latRaw !== '') {
      const latValue = Number(latRaw);
      if (!Number.isNaN(latValue)) {
        payload.latitude = latValue;
      }
    }

    const lonRaw = formData.get('longitude');
    if (lonRaw !== null && lonRaw !== '') {
      const lonValue = Number(lonRaw);
      if (!Number.isNaN(lonValue)) {
        payload.longitude = lonValue;
      }
    }

    return payload;
  };

  const fillRealtimeDefaults = () => {
    if (!realtimeForm) return;
    setObservationTime(false);

    if (roadSelect && !roadSelect.value) {
      roadSelect.value = roads[0]?.id || '';
      applyRoadSelection(roadSelect.value);
    } else if (roadSelect && roadSelect.value) {
      applyRoadSelection(roadSelect.value);
    }
  };

  if (realtimeForm && realtimeResult && realtimeSubmit) {
    fillRealtimeDefaults();
    realtimeForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!realtimeForm.reportValidity()) {
        return;
      }
      const payload = collectRealtimePayload();
      const originalLabel = realtimeSubmit.textContent;
      realtimeSubmit.disabled = true;
      realtimeSubmit.textContent = 'ƒêang d·ª± b√°o...';
      if (realtimeRefresh) {
        realtimeRefresh.disabled = true;
      }
      showRealtimeLoading();
      try {
        const response = await fetch('/api/realtime', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        const text = await response.text();
        let data = {};
        if (text) {
          try {
            data = JSON.parse(text);
          } catch (err) {
            console.error('Kh√¥ng th·ªÉ parse JSON:', err);
          }
        }
        if (!response.ok) {
          const message = data?.error || `Y√™u c·∫ßu th·∫•t b·∫°i (${response.status})`;
          showRealtimeError(message, data?.details);
          return;
        }
        showRealtimeSuccess(data);
      } catch (err) {
        console.error(err);
        showRealtimeError('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi API realtime.', err?.message || String(err));
      } finally {
        realtimeSubmit.disabled = false;
        realtimeSubmit.textContent = originalLabel;
        if (realtimeRefresh) {
          realtimeRefresh.disabled = false;
        }
      }
    });
  }

  if (realtimeRefresh) {
    realtimeRefresh.addEventListener('click', () => {
      setObservationTime(true);
    });
  }

  const hourlyData = {{ analysis.hourly | default([]) | tojson }};
  const weekdayData = {{ analysis.weekday | default([]) | tojson }};
  const featureImportance = {{ analysis.feature_importance | default([]) | tojson }};

  const chartColors = {
    line: 'rgba(56, 189, 248, 0.9)',
    fill: 'rgba(56, 189, 248, 0.18)',
    line2: 'rgba(244, 114, 182, 0.9)',
    fill2: 'rgba(244, 114, 182, 0.18)'
  };

  if (hourlyData.length) {
    const ctx = document.getElementById('chartHourly');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: hourlyData.map(d => `${d.hour}h`),
        datasets: [
          {
            label: 'T·ªëc ƒë·ªô trung b√¨nh (km/h)',
            data: hourlyData.map(d => d.avg_speed),
            borderColor: chartColors.line,
            backgroundColor: chartColors.fill,
            fill: true,
            tension: 0.35,
            borderWidth: 2
          },
          {
            label: 'X√°c su·∫•t t·∫Øc ngh·∫Ωn',
            data: hourlyData.map(d => d.avg_prob_congestion),
            borderColor: chartColors.line2,
            backgroundColor: chartColors.fill2,
            fill: true,
            tension: 0.35,
            borderWidth: 2,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(148, 163, 184, 0.2)' }
          },
          y1: {
            position: 'right',
            beginAtZero: true,
            grid: { drawOnChartArea: false }
          },
          x: {
            grid: { color: 'rgba(148, 163, 184, 0.15)' }
          }
        },
        plugins: {
          legend: {
            labels: { color: '#cbd5f5' }
          }
        }
      }
    });
  }

  if (weekdayData.length) {
    const weekdayNames = ['N/A', 'Ch·ªß nh·∫≠t', 'Th·ª© hai', 'Th·ª© ba', 'Th·ª© t∆∞', 'Th·ª© nƒÉm', 'Th·ª© s√°u', 'Th·ª© b·∫£y'];
    const ctx2 = document.getElementById('chartWeekday');
    new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: weekdayData.map(d => weekdayNames[d.weekday] || d.weekday),
        datasets: [
          {
            label: 'X√°c su·∫•t t·∫Øc ngh·∫Ωn',
            data: weekdayData.map(d => d.avg_prob_congestion),
            backgroundColor: 'rgba(248, 113, 113, 0.6)',
            borderRadius: 8
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, grid: { color: 'rgba(148, 163, 184, 0.2)' } },
          x: { grid: { display: false } }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  }

  const histogramData = {{ analysis.histogram | default([]) | tojson }};
  if (histogramData.length) {
    const ctxHist = document.getElementById('chartHistogram');
    const labels = histogramData.map(d => `${Math.round(d.bin_lower)} - ${Math.round(d.bin_upper)} km/h`);
    const counts = histogramData.map(d => d.count);
    new Chart(ctxHist, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'S·ªë l∆∞·ª£ng b·∫£n ghi',
          data: counts,
          backgroundColor: 'rgba(59, 130, 246, 0.6)',
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { grid: { color: 'rgba(148, 163, 184, 0.15)' } },
          y: { beginAtZero: true, grid: { color: 'rgba(148, 163, 184, 0.2)' } }
        },
        plugins: { legend: { display: false } }
      }
    });
  } else {
    const ctxHist = document.getElementById('chartHistogram');
    if (ctxHist) {
      ctxHist.replaceWith(Object.assign(document.createElement('p'), {
        textContent: 'Ch∆∞a c√≥ d·ªØ li·ªáu histogram. H√£y ch·∫°y l·∫°i pipeline.',
        style: 'color: var(--muted); text-align:center; margin-top:40px;'
      }));
    }
  }

  const dailyData = {{ analysis.daily | default([]) | tojson }};
  if (dailyData.length) {
    const ctxDaily = document.getElementById('chartDaily');
    const labels = dailyData.map(d => d.date);
    const speeds = dailyData.map(d => d.avg_speed);
    new Chart(ctxDaily, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'T·ªëc ƒë·ªô trung b√¨nh (km/h)',
          data: speeds,
          borderColor: 'rgba(16, 185, 129, 0.9)',
          backgroundColor: 'rgba(16, 185, 129, 0.2)',
          fill: true,
          tension: 0.25,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        scales: { y: { grid: { color: 'rgba(148, 163, 184, 0.2)' } }, x: { grid: { display: false } } },
        plugins: { legend: { labels: { color: '#cbd5f5' } } }
      }
    });
  } else {
    const ctxDaily = document.getElementById('chartDaily');
    if (ctxDaily) {
      ctxDaily.replaceWith(Object.assign(document.createElement('p'), {
        textContent: 'Ch∆∞a c√≥ d·ªØ li·ªáu xu h∆∞·ªõng theo ng√†y.',
        style: 'color: var(--muted); text-align:center; margin-top:40px;'
      }));
    }
  }

  const heatmapData = {{ analysis.heatmap | default([]) | tojson }};
  if (heatmapData.length) {
    const container = document.getElementById('heatmap-table');
    const weekdayOrder = [2, 3, 4, 5, 6, 7, 1];
    const weekdayNames = {
      1: 'Ch·ªß nh·∫≠t',
      2: 'Th·ª© hai',
      3: 'Th·ª© ba',
      4: 'Th·ª© t∆∞',
      5: 'Th·ª© nƒÉm',
      6: 'Th·ª© s√°u',
      7: 'Th·ª© b·∫£y'
    };
    const hours = [...new Set(heatmapData.map(d => d.hour))].sort((a, b) => a - b);
    const values = heatmapData.map(d => d.avg_speed).filter(v => typeof v === 'number');
    const minVal = Math.min(...values);
    const maxVal = Math.max(...values);
    const heatColor = (value) => {
      if (typeof value !== 'number' || isNaN(value)) return 'transparent';
      const ratio = maxVal === minVal ? 0.5 : (value - minVal) / (maxVal - minVal);
      const hue = 120 - ratio * 120;
      return `hsl(${hue}, 85%, 50%)`;
    };
    if (container) {
      const table = document.createElement('table');
      table.className = 'heatmap';
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      headerRow.appendChild(document.createElement('th'));
      hours.forEach(hour => {
        const th = document.createElement('th');
        th.textContent = `${hour}h`;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      weekdayOrder.forEach(weekdayValue => {
        const weekdayRow = document.createElement('tr');
        const labelCell = document.createElement('th');
        labelCell.textContent = weekdayNames[weekdayValue];
        weekdayRow.appendChild(labelCell);
        hours.forEach(hour => {
          const cell = document.createElement('td');
          const match = heatmapData.find(d => d.weekday === weekdayValue && d.hour === hour);
          const value = match ? parseFloat(match.avg_speed) : null;
          cell.textContent = value && !isNaN(value) ? value.toFixed(1) : '';
          cell.style.background = heatColor(value);
          cell.style.color = value && !isNaN(value) ? '#021122' : '#94a3b8';
          weekdayRow.appendChild(cell);
        });
        tbody.appendChild(weekdayRow);
      });
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }
  }
  else {
    const container = document.getElementById('heatmap-table');
    if (container) {
      container.innerHTML = '<p style="color: var(--muted); text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu heatmap.</p>';
    }
  }

  const sensorActivity = {{ analysis.sensor_activity | default([]) | tojson }};
  if (sensorActivity.length) {
    const ctxSensor = document.getElementById('chartSensorActivity');
    const topSensors = sensorActivity.sort((a, b) => b.count - a.count).slice(0, 12);
    new Chart(ctxSensor, {
      type: 'bar',
      data: {
        labels: topSensors.map(d => d.sensor),
        datasets: [{
          label: 'S·ªë ƒëi·ªÉm d·ªØ li·ªáu',
          data: topSensors.map(d => d.count),
          backgroundColor: 'rgba(190, 242, 100, 0.65)',
          borderRadius: 6
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        scales: {
          x: { grid: { color: 'rgba(148, 163, 184, 0.2)' } },
          y: { grid: { display: false } }
        },
        plugins: { legend: { display: false } }
      }
    });
  } else {
    const ctxSensor = document.getElementById('chartSensorActivity');
    if (ctxSensor) {
      ctxSensor.replaceWith(Object.assign(document.createElement('p'), {
        textContent: 'Ch∆∞a c√≥ th·ªëng k√™ ho·∫°t ƒë·ªông c·∫£m bi·∫øn.',
        style: 'color: var(--muted); text-align:center; margin-top:40px;'
      }));
    }
  }

  if (featureImportance.length) {
    const ctxFI = document.getElementById('chartFeatureImportance');
    if (ctxFI) {
      const labels = featureImportance.map(d => d.feature || '‚Äî');
      const importanceValues = featureImportance.map(d => (d.importance || 0) * 100);
      const coeffValues = featureImportance.map(d => d.coefficient || 0);
      new Chart(ctxFI, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'ƒê·ªô quan tr·ªçng (%)',
            data: importanceValues,
            backgroundColor: 'rgba(37, 99, 235, 0.68)',
            borderRadius: 10,
            maxBarThickness: 28
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          scales: {
            x: {
              beginAtZero: true,
              grid: { color: 'rgba(148, 163, 184, 0.18)' },
              ticks: {
                callback: value => `${value}%`,
                color: '#e2e8f0'
              }
            },
            y: {
              grid: { display: false },
              ticks: { color: '#e2e8f0' }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const idx = ctx.dataIndex;
                  const pct = (importanceValues[idx] || 0).toFixed(1);
                  const coef = (coeffValues[idx] || 0).toFixed(3);
                  return [`ƒê·ªô quan tr·ªçng: ${pct}%`, `H·ªá s·ªë: ${coef}`];
                }
              }
            }
          }
        }
      });
    }
  } else {
    const ctxFI = document.getElementById('chartFeatureImportance');
    if (ctxFI) {
      ctxFI.replaceWith(Object.assign(document.createElement('p'), {
        textContent: 'Ch∆∞a c√≥ d·ªØ li·ªáu v·ªÅ ƒë·ªô quan tr·ªçng ƒë·∫∑c tr∆∞ng.',
        style: 'color: var(--muted); text-align:center; margin-top:40px;'
      }));
    }
  }

  const topSensorHourly = {{ analysis.top_sensor_hourly | default([]) | tojson }};
  if (topSensorHourly.length) {
    const ctxTopSensor = document.getElementById('chartTopSensor');
    const sensors = [...new Set(topSensorHourly.map(d => d.sensor))];
    const hours = [...new Set(topSensorHourly.map(d => d.hour))].sort((a, b) => a - b);
    const palette = ['#38bdf8', '#f472b6', '#facc15', '#22c55e', '#a855f7'];
    const datasets = sensors.map((sensor, idx) => {
      const values = hours.map(hour => {
        const entry = topSensorHourly.find(d => d.sensor === sensor && d.hour === hour);
        return entry ? entry.avg_speed : null;
      });
      return {
        label: sensor,
        data: values,
        borderColor: palette[idx % palette.length],
        backgroundColor: palette[idx % palette.length],
        tension: 0.3,
        fill: false,
        spanGaps: true,
        borderWidth: 2
      };
    });
    new Chart(ctxTopSensor, {
      type: 'line',
      data: {
        labels: hours.map(h => `${h}h`),
        datasets
      },
      options: {
        responsive: true,
        scales: {
          y: { grid: { color: 'rgba(148, 163, 184, 0.2)' } },
          x: { grid: { color: 'rgba(148, 163, 184, 0.15)' } }
        },
        plugins: { legend: { labels: { color: '#cbd5f5' } } }
      }
    });
  } else {
    const ctxTopSensor = document.getElementById('chartTopSensor');
    if (ctxTopSensor) {
      ctxTopSensor.replaceWith(Object.assign(document.createElement('p'), {
        textContent: 'Ch∆∞a c√≥ d·ªØ li·ªáu so s√°nh c·∫£m bi·∫øn.',
        style: 'color: var(--muted); text-align:center; margin-top:40px;'
      }));
    }
  }
</script>
{% endblock %}
